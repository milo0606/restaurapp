<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RestaurApp</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        indigo: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' },
                        slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' }
                    }
                }
            }
        }
    </script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Estilos base -->
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body { font-family: system-ui, -apple-system, sans-serif; }
        .checkbox-wrapper input:checked + div { background-color: #4f46e5; border-color: #4f46e5; }
        .checkbox-wrapper input:checked + div svg { display: block; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-100 transition-colors duration-300 min-h-screen">

    <!-- APP CONTAINER -->
    <div id="app">
        
        <!-- BANNER DE ERROR DE PERMISOS -->
        <div id="permission-error-banner" class="hidden fixed top-0 left-0 right-0 z-[100] bg-red-600 text-white p-4 shadow-lg animate-in slide-in-from-top duration-300">
            <div class="max-w-5xl mx-auto">
                <div class="flex items-start gap-3">
                    <i data-lucide="alert-triangle" class="w-6 h-6 flex-shrink-0 mt-0.5"></i>
                    <div class="flex-1 text-sm">
                        <h3 class="font-bold text-lg mb-1">Base de Datos Bloqueada</h3>
                        <p class="mb-2">Firebase est√° rechazando las conexiones. Para solucionar esto:</p>
                        <ol class="list-decimal list-inside space-y-1 mb-3 opacity-90">
                            <li>Ve a <a href="https://console.firebase.google.com/" target="_blank" class="underline hover:text-white font-bold">Firebase Console</a> > Firestore Database > Reglas.</li>
                            <li>Cambia <code>allow read, write: if false;</code> por:</li>
                        </ol>
                        <div class="bg-black/30 p-3 rounded-lg font-mono text-xs overflow-x-auto mb-3 border border-white/20 select-all">
                            allow read, write: if request.auth != null;
                        </div>
                        <div class="flex gap-3">
                            <button onclick="window.location.reload()" class="bg-white text-red-700 px-4 py-2 rounded-lg font-bold text-xs hover:bg-red-50 transition-colors shadow-sm">
                                Ya actualic√© las reglas, Recargar
                            </button>
                            <button onclick="document.getElementById('permission-error-banner').classList.add('hidden')" class="px-4 py-2 rounded-lg font-bold text-xs hover:bg-white/10 transition-colors text-white">
                                Cerrar aviso
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loading-screen" class="fixed inset-0 flex items-center justify-center bg-slate-50 dark:bg-slate-950 z-50">
            <div class="animate-spin text-indigo-600 dark:text-indigo-400">
                <i data-lucide="loader-2" class="w-12 h-12"></i>
            </div>
        </div>

        <!-- USERNAME SETUP MODAL -->
        <div id="modal-username" class="hidden fixed inset-0 bg-slate-900 z-[90] flex items-center justify-center p-6">
            <div class="bg-white dark:bg-slate-900 rounded-3xl p-8 max-w-md w-full text-center border border-slate-100 dark:border-slate-800 shadow-2xl relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-500/10 rounded-full blur-2xl"></div>
                <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-purple-500/10 rounded-full blur-2xl"></div>
                <div class="relative z-10">
                    <div class="mx-auto w-20 h-20 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mb-6 border border-indigo-200 dark:border-indigo-800">
                        <i data-lucide="smile" class="w-10 h-10 text-indigo-600 dark:text-indigo-400"></i>
                    </div>
                    <h2 class="text-2xl font-black mb-2 text-slate-900 dark:text-white">¬°Bienvenido!</h2>
                    <p class="text-slate-500 dark:text-slate-400 mb-8">Antes de empezar, ¬øc√≥mo quieres que te llamemos?</p>
                    <form id="username-form" onsubmit="saveUsername(event)">
                        <input type="text" id="input-username" required placeholder="Tu nombre de usuario" class="w-full p-4 bg-slate-50 dark:bg-slate-800/50 border-2 border-slate-200 dark:border-slate-700 rounded-2xl text-center text-lg font-bold outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 mb-6 dark:text-white transition-all">
                        <button type="submit" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-indigo-700 transition-all transform active:scale-95">Continuar</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Login Screen -->
        <div id="login-view" class="hidden min-h-screen flex items-center justify-center p-6 relative overflow-hidden">
            <div class="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl p-8 max-w-md w-full text-center relative z-10 border border-slate-100 dark:border-slate-800">
                <div class="mx-auto w-20 h-20 bg-indigo-600 rounded-2xl flex items-center justify-center mb-6 shadow-lg rotate-3">
                    <i data-lucide="store" class="w-10 h-10 text-white"></i>
                </div>
                <h1 class="text-3xl font-black text-slate-800 dark:text-white mb-2">RestaurApp</h1>
                <p class="text-slate-500 dark:text-slate-400 mb-8">Guarda tus rincones favoritos.</p>
                <button id="btn-google-login" class="w-full flex items-center justify-center gap-3 bg-white dark:bg-slate-800 text-slate-700 dark:text-white border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 py-3.5 rounded-xl font-bold shadow-sm mb-6 transition-all">
                    <svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                    Continuar con Google
                </button>
                <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-slate-200 dark:border-slate-700"></div><span class="flex-shrink-0 mx-4 text-slate-400 text-xs">O tambi√©n</span><div class="flex-grow border-t border-slate-200 dark:border-slate-700"></div></div>
                <button id="btn-guest-login" class="w-full flex items-center justify-center gap-2 mt-4 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 font-semibold text-sm transition-colors"><i data-lucide="user" class="w-4 h-4"></i> Entrar como Invitado</button>
            </div>
        </div>

        <!-- Main App View -->
        <div id="main-view" class="hidden pb-32">
            <!-- HEADER -->
            <header class="p-4 sticky top-0 z-30 shadow-md bg-indigo-600 dark:bg-slate-900 text-white border-b dark:border-slate-800 transition-colors">
                <div class="max-w-5xl mx-auto space-y-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <button id="btn-back-shared" class="hidden p-1 hover:bg-white/20 rounded-full mr-1"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                            <h1 id="app-title" class="text-xl font-bold flex items-center gap-2"><i data-lucide="store" class="text-indigo-200"></i> RestaurApp</h1>
                        </div>
                        <div class="flex items-center gap-3">
                            <button id="btn-theme-toggle" class="p-2 rounded-full hover:bg-white/20 transition-colors"><i data-lucide="moon" id="icon-theme" class="w-5 h-5 text-indigo-100"></i></button>
                            <button id="btn-profile-ai" class="flex items-center gap-2 px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded-full text-xs font-bold border border-white/20"><i data-lucide="pie-chart" class="w-4 h-4"></i> <span class="hidden sm:inline">Perfil IA</span></button>
                            <div id="user-section" class="flex items-center gap-2 pl-2 border-l border-white/20">
                                <img id="user-avatar" src="" class="hidden w-8 h-8 rounded-full border border-white/50 object-cover">
                                <div id="user-info-display" class="hidden sm:flex flex-col items-end mr-1"><span id="user-name-display" class="text-xs font-bold leading-none">Usuario</span></div>
                                <i id="user-icon-default" data-lucide="user-circle" class="w-7 h-7 text-indigo-100 hidden"></i>
                                <button id="btn-logout" class="p-2 rounded-full hover:bg-red-500/20 text-red-100 hover:text-red-200"><i data-lucide="log-out" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- TAB HOME -->
            <div id="tab-home">
                <div id="header-search-container" class="bg-indigo-600 dark:bg-slate-900 px-4 pb-4 sticky top-[72px] z-20">
                    <div class="max-w-5xl mx-auto flex gap-2">
                        <div class="relative flex-1">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-indigo-200"></i>
                            <input id="input-search" type="text" placeholder="Buscar..." class="w-full bg-indigo-700/50 dark:bg-slate-800/50 border border-indigo-500/50 dark:border-slate-600 rounded-xl pl-10 pr-10 py-2.5 text-sm text-white placeholder-indigo-200/60 focus:outline-none focus:ring-2 focus:ring-white/20">
                            <button id="btn-clear-search" class="hidden absolute right-3 top-1/2 -translate-y-1/2 text-white/70 hover:text-white"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>
                        <div class="relative">
                            <select id="select-sort" class="appearance-none h-full bg-indigo-700/50 dark:bg-slate-800/50 border border-indigo-500/50 dark:border-slate-600 text-white pl-3 pr-8 py-2.5 rounded-xl text-sm font-medium focus:outline-none cursor-pointer">
                                <option class="text-slate-800" value="date-desc">üìÖ Recientes</option>
                                <option class="text-slate-800" value="date-asc">üìÖ Antiguos</option>
                                <option class="text-slate-800" value="rating-desc">‚≠ê Mejores</option>
                                <option class="text-slate-800" value="rating-asc">‚≠ê Peores</option>
                            </select>
                            <i data-lucide="arrow-up-down" class="absolute right-2.5 top-1/2 -translate-y-1/2 w-3 h-3 text-indigo-200 pointer-events-none"></i>
                        </div>
                    </div>
                </div>
                <div id="header-categories-container" class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-[136px] z-20 overflow-x-auto scrollbar-hide">
                    <div id="categories-container" class="flex p-2 gap-2 max-w-5xl mx-auto min-w-max"></div>
                </div>
                <main class="max-w-5xl mx-auto p-4">
                    <div id="places-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    <div id="empty-state" class="hidden text-center py-20 opacity-50 flex flex-col items-center">
                        <i data-lucide="search" class="w-12 h-12 mb-4 text-slate-300 dark:text-slate-600"></i>
                        <p class="text-lg">No se encontraron sitios.</p>
                    </div>
                </main>
                <button id="btn-fab" class="fixed bottom-24 right-6 bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-full shadow-lg hover:scale-105 active:scale-95 transition-all z-40"><i data-lucide="plus" class="w-7 h-7"></i></button>
            </div>

            <!-- TAB SHARED -->
            <div id="tab-shared" class="hidden max-w-5xl mx-auto p-4 pt-6 space-y-6">
                <div class="flex items-center justify-between bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-50 dark:bg-indigo-900/30 p-2 rounded-lg text-indigo-600 dark:text-indigo-400"><i data-lucide="share-2" class="w-5 h-5"></i></div>
                        <div><h3 class="font-bold text-sm text-slate-800 dark:text-white">Compartir Lista</h3><p class="text-xs text-slate-500">Crea enlaces para tus amigos</p></div>
                    </div>
                    <button onclick="openShareWizard()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold rounded-lg transition-colors">Nueva Lista</button>
                </div>
                <div id="shared-history-list" class="space-y-3">
                    <div class="text-center py-12 opacity-40"><p class="text-sm text-slate-500 dark:text-slate-400">Tus enlaces compartidos aparecer√°n aqu√≠.</p></div>
                </div>
            </div>

            <!-- BOTTOM NAV -->
            <div id="bottom-nav" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50">
                <nav class="bg-white/90 dark:bg-slate-900/90 backdrop-blur-md shadow-2xl border border-slate-200/50 dark:border-slate-700/50 rounded-full p-1.5 flex gap-2">
                    <button onclick="switchView('home')" id="nav-home" class="p-3.5 rounded-full transition-all bg-indigo-100 text-indigo-600 dark:bg-indigo-900 dark:text-indigo-300"><i data-lucide="home" class="w-6 h-6"></i></button>
                    <button onclick="switchView('shared')" id="nav-shared" class="p-3.5 rounded-full transition-all text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800"><i data-lucide="share-2" class="w-6 h-6"></i></button>
                </nav>
            </div>
        </div>

        <!-- MODAL: SHARED LIST VIEW (POPUP) -->
        <div id="modal-shared-list-view" class="hidden fixed inset-0 bg-slate-100 dark:bg-slate-950 z-[60] overflow-y-auto animate-fade-in">
             <div class="max-w-5xl mx-auto min-h-screen flex flex-col">
                <div class="p-4 bg-indigo-600 dark:bg-slate-900 text-white shadow-md sticky top-0 z-20">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <button onclick="closeSharedListModal()" class="p-2 hover:bg-white/20 rounded-full"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                            <div><h2 id="shared-view-title" class="text-lg font-bold leading-tight">Nombre Lista</h2><p class="text-xs text-indigo-200 opacity-80">Vista Previa</p></div>
                        </div>
                    </div>
                </div>

                <!-- Shared List Filter Controls (NEW) -->
                <div class="bg-indigo-600 dark:bg-slate-900 px-4 pb-4 sticky top-[64px] z-20 transition-colors shadow-sm">
                    <div class="flex flex-col sm:flex-row gap-2 mb-2">
                         <!-- Search -->
                        <div class="relative flex-1">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-indigo-200"></i>
                            <input id="shared-input-search" type="text" placeholder="Buscar..." class="w-full bg-indigo-700/50 dark:bg-slate-800/50 border border-indigo-500/50 dark:border-slate-600 rounded-xl pl-10 pr-2 py-2 text-sm text-white placeholder-indigo-200/60 focus:outline-none focus:ring-2 focus:ring-white/20">
                        </div>
                        <div class="flex gap-2">
                             <!-- Sort -->
                            <div class="relative flex-1 sm:flex-none">
                                 <select id="shared-select-sort" class="appearance-none h-full w-full bg-indigo-700/50 dark:bg-slate-800/50 border border-indigo-500/50 dark:border-slate-600 text-white pl-3 pr-8 py-2 rounded-xl text-xs font-medium focus:outline-none cursor-pointer">
                                    <option class="text-slate-800" value="date-desc">Recientes</option>
                                    <option class="text-slate-800" value="date-asc">Antiguos</option>
                                    <option class="text-slate-800" value="rating-desc">Mejores</option>
                                </select>
                                <i data-lucide="arrow-up-down" class="absolute right-2.5 top-1/2 -translate-y-1/2 w-3 h-3 text-indigo-200 pointer-events-none"></i>
                            </div>
                            <!-- User Filter (NEW) -->
                             <div class="relative flex-1 sm:flex-none">
                                 <select id="shared-select-user" class="appearance-none h-full w-full bg-indigo-700/50 dark:bg-slate-800/50 border border-indigo-500/50 dark:border-slate-600 text-white pl-3 pr-8 py-2 rounded-xl text-xs font-medium focus:outline-none cursor-pointer">
                                    <option class="text-slate-800" value="all">Todos los usuarios</option>
                                </select>
                                <i data-lucide="user" class="absolute right-2.5 top-1/2 -translate-y-1/2 w-3 h-3 text-indigo-200 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
                    <!-- Categories -->
                    <div id="shared-categories-container" class="flex gap-2 overflow-x-auto scrollbar-hide pb-1"></div>
                </div>

                <div class="p-4 flex-1">
                    <div id="shared-view-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
             </div>
        </div>

        <!-- MODAL: DETAILS -->
        <div id="modal-details" class="hidden fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
            <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto flex flex-col relative overflow-hidden">
                <div class="relative h-64 sm:h-72 w-full bg-slate-100 dark:bg-slate-800 shrink-0">
                    <div id="detail-images" class="flex overflow-x-auto snap-x snap-mandatory h-full w-full scrollbar-hide"></div>
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-black/30 pointer-events-none"></div>
                    <button onclick="closeDetails()" class="absolute top-4 right-4 p-2 bg-black/20 hover:bg-black/40 text-white rounded-full backdrop-blur-md transition-colors z-10"><i data-lucide="x" class="w-5 h-5"></i></button>
                     <div id="detail-image-count" class="absolute bottom-4 right-4 px-3 py-1 bg-black/60 backdrop-blur-md rounded-full text-xs font-bold text-white flex items-center gap-1 hidden">
                        <i data-lucide="image" class="w-3 h-3"></i> <span id="detail-image-count-text"></span>
                     </div>
                </div>
                <div class="p-6 space-y-6">
                    <div class="space-y-2">
                        <div class="flex justify-between items-start">
                             <span id="detail-type" class="px-2.5 py-1 bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300 rounded-lg text-[10px] font-bold uppercase tracking-wider">Restaurante</span>
                             <div class="flex items-center gap-1.5 bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-500 px-2.5 py-1 rounded-lg text-xs font-bold">
                                <i data-lucide="star" class="w-3 h-3 fill-current"></i> <span id="detail-rating">0</span>/5
                             </div>
                        </div>
                        <h2 id="detail-name" class="text-3xl font-black text-slate-900 dark:text-white leading-tight">Nombre del Sitio</h2>
                        
                        <!-- Added By Field -->
                        <div id="detail-added-by-container" class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400 mt-1 hidden">
                            <span class="bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded-md border border-slate-200 dark:border-slate-700 flex items-center gap-1">
                                <i data-lucide="user" class="w-3 h-3 text-indigo-500"></i> A√±adido por: <strong id="detail-added-by" class="text-slate-700 dark:text-slate-200">Usuario</strong>
                            </span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 p-4 bg-slate-50 dark:bg-slate-800/50 rounded-2xl border border-slate-100 dark:border-slate-800">
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-bold text-slate-400 uppercase">Fecha Visita</span>
                            <div class="flex items-center gap-2 text-slate-700 dark:text-slate-200 text-sm font-medium">
                                <i data-lucide="calendar" class="w-4 h-4 text-indigo-500"></i>
                                <span id="detail-date">...</span>
                            </div>
                        </div>
                        <div class="flex flex-col gap-1">
                             <span class="text-[10px] font-bold text-slate-400 uppercase">Ubicaci√≥n</span>
                            <div class="flex items-center gap-2 text-slate-700 dark:text-slate-200 text-sm font-medium">
                                <i data-lucide="map-pin" class="w-4 h-4 text-indigo-500"></i>
                                <span id="detail-address" class="truncate">...</span>
                            </div>
                        </div>
                    </div>
                    <div id="detail-tags-section" class="grid grid-cols-1 gap-4"></div>
                    <div id="detail-comment-section" class="hidden">
                        <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-2">Tu Rese√±a</h3>
                        <div class="relative bg-white dark:bg-slate-800 p-4 rounded-xl border-l-4 border-indigo-500 shadow-sm">
                            <p id="detail-comment" class="text-slate-600 dark:text-slate-300 italic leading-relaxed text-sm break-words whitespace-pre-wrap"></p>
                        </div>
                    </div>
                </div>
                <div class="p-6 pt-0 mt-auto" id="detail-actions">
                     <button onclick="editFromDetails()" class="w-full bg-slate-900 dark:bg-indigo-600 hover:bg-slate-800 dark:hover:bg-indigo-700 text-white py-3.5 rounded-xl font-bold shadow-lg transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="pencil" class="w-4 h-4"></i> Editar Detalles
                     </button>
                </div>
            </div>
        </div>

        <!-- MODAL: ADD/EDIT (Same as before) -->
        <div id="modal-form" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto flex flex-col">
                <div class="p-4 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center sticky top-0 bg-white dark:bg-slate-900 z-10">
                    <h2 id="modal-title" class="text-lg font-bold text-slate-800 dark:text-white">Nuevo Sitio</h2>
                    <button id="btn-close-modal" class="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full"><i data-lucide="x" class="w-6 h-6 text-slate-500"></i></button>
                </div>
                <form id="place-form" class="p-6 space-y-5">
                    <input type="hidden" id="edit-id">
                    <div class="space-y-2">
                        <label class="text-xs font-semibold text-slate-500 uppercase">Foto</label>
                        <div class="relative group h-48 w-full border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl overflow-hidden bg-slate-50 dark:bg-slate-800">
                            <img id="preview-img-0" class="hidden w-full h-full object-cover">
                            <div id="upload-placeholder-0" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                <i data-lucide="camera" class="w-8 h-8 text-slate-400 mb-2"></i>
                                <span class="text-xs text-slate-500">Toca para agregar</span>
                            </div>
                            <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleImageUpload(this, 0)">
                            <button type="button" id="btn-remove-img-0" class="hidden absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full z-20"><i data-lucide="x" class="w-4 h-4"></i></button>
                            <button type="button" id="btn-analyze-ai" class="hidden absolute bottom-2 left-2 right-2 bg-indigo-600/90 text-white text-xs font-bold py-2 rounded-lg backdrop-blur-sm flex items-center justify-center gap-2 z-20"><i data-lucide="sparkles" class="w-3 h-3"></i> Analizar</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-slate-500 uppercase">Nombre</label>
                            <input type="text" id="input-name" required class="w-full p-2.5 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-slate-800 dark:text-white">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-slate-500 uppercase">Tipo</label>
                            <select id="input-type" class="w-full p-2.5 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-slate-800 dark:text-white"></select>
                            <input type="text" id="input-custom-type" class="hidden w-full mt-2 p-2.5 bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-300 dark:border-indigo-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-indigo-700 dark:text-indigo-300 placeholder-indigo-400 dark:placeholder-indigo-500/50" placeholder="Escribe el nombre de la categor√≠a...">
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">Direcci√≥n</label>
                        <div class="relative">
                            <i data-lucide="map-pin" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
                            <input type="text" id="input-address" class="w-full p-2.5 pl-10 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-800 dark:text-white">
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">Rating</label>
                        <div class="flex items-center gap-2 bg-slate-50 dark:bg-slate-800 p-3 rounded-lg border border-slate-200 dark:border-slate-700 justify-center">
                            <div id="star-rating-container" class="flex gap-1"></div>
                            <span id="rating-value" class="font-bold ml-2 text-slate-800 dark:text-white">0/5</span>
                        </div>
                    </div>
                    <div class="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl border border-indigo-100 dark:border-indigo-800/30">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-sm font-bold text-indigo-800 dark:text-indigo-300 flex items-center gap-2"><i data-lucide="sparkles" class="w-3 h-3"></i> Sugerencias IA</h3>
                            <button type="button" id="btn-generate-tags" class="text-[10px] bg-indigo-600 text-white px-3 py-1 rounded-full">Generar</button>
                        </div>
                        <div class="mb-2"><span class="text-xs font-bold text-green-600 block mb-1">LO BUENO</span><div id="tags-good-container" class="flex flex-wrap gap-2"></div></div>
                        <div><span class="text-xs font-bold text-red-600 block mb-1">LO MALO</span><div id="tags-bad-container" class="flex flex-wrap gap-2"></div></div>
                    </div>
                    <div class="space-y-2">
                         <label class="text-xs font-semibold text-slate-500 uppercase flex justify-between">Evidencias <span class="text-[10px] font-normal normal-case opacity-70">M√°x 2 fotos</span></label>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="relative group h-24 w-full border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl overflow-hidden bg-slate-50 dark:bg-slate-800">
                                <img id="preview-img-1" class="hidden w-full h-full object-cover">
                                <div id="upload-placeholder-1" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none text-slate-400"><i data-lucide="camera" class="w-5 h-5 mb-1"></i><span class="text-[10px]">Foto 1</span></div>
                                <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleImageUpload(this, 1)">
                                <button type="button" id="btn-remove-img-1" class="hidden absolute top-1 right-1 bg-red-500 text-white p-0.5 rounded-full z-20"><i data-lucide="x" class="w-3 h-3"></i></button>
                            </div>
                            <div class="relative group h-24 w-full border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl overflow-hidden bg-slate-50 dark:bg-slate-800">
                                <img id="preview-img-2" class="hidden w-full h-full object-cover">
                                <div id="upload-placeholder-2" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none text-slate-400"><i data-lucide="camera" class="w-5 h-5 mb-1"></i><span class="text-[10px]">Foto 2</span></div>
                                <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleImageUpload(this, 2)">
                                <button type="button" id="btn-remove-img-2" class="hidden absolute top-1 right-1 bg-red-500 text-white p-0.5 rounded-full z-20"><i data-lucide="x" class="w-3 h-3"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <div class="flex justify-between items-end mb-1"><label class="text-xs font-semibold text-slate-500 uppercase">Comentario</label><button type="button" id="btn-enhance-comment" class="text-[10px] text-indigo-600 font-bold flex items-center gap-1"><i data-lucide="wand-2" class="w-3 h-3"></i> Mejorar</button></div>
                        <textarea id="input-comment" rows="3" class="w-full p-2.5 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-800 dark:text-white"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold shadow-lg">Guardar Sitio</button>
                </form>
            </div>
        </div>

        <!-- MODAL: SHARE WIZARD -->
        <div id="modal-share-wizard" class="hidden fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
                <div id="share-step-1" class="flex flex-col h-full">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex-shrink-0">
                        <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-slate-800 dark:text-white">Selecciona Secciones</h2><button onclick="closeShareWizard()" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800"><i data-lucide="x" class="w-5 h-5 text-slate-500"></i></button></div>
                        <div class="flex justify-between items-center"><p class="text-xs text-slate-500">¬øQu√© categor√≠as quieres incluir?</p><button onclick="toggleSelectAllCats()" class="text-xs font-bold text-indigo-600 bg-indigo-50 dark:bg-indigo-900/30 px-3 py-1 rounded-lg hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition-colors">Seleccionar Todas</button></div>
                    </div>
                    <div class="p-4 overflow-y-auto space-y-2 h-[300px] bg-slate-50/50 dark:bg-slate-800/30" id="share-cat-list"></div>
                    <div class="p-6 border-t border-slate-100 dark:border-slate-800 flex-shrink-0"><button onclick="goToShareStep2()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Siguiente</button></div>
                </div>
                <div id="share-step-2" class="hidden flex flex-col h-full">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex-shrink-0">
                        <div class="flex justify-between items-center mb-2"><button onclick="goToShareStep1()" class="flex items-center text-sm font-bold text-slate-500 hover:text-indigo-600"><i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i> Atr√°s</button><button id="btn-select-all-places" onclick="toggleSelectAllShare()" class="text-xs font-bold text-indigo-600 bg-indigo-50 dark:bg-indigo-900/30 px-3 py-1 rounded-lg">Seleccionar Todos</button></div>
                        <h2 class="text-lg font-bold text-slate-800 dark:text-white">Selecciona Sitios</h2>
                    </div>
                    <div class="p-4 overflow-y-auto space-y-2 h-[300px] bg-slate-50/50 dark:bg-slate-800/30" id="share-place-list"></div>
                    <div class="p-6 border-t border-slate-100 dark:border-slate-800 flex-shrink-0"><button onclick="goToShareStep3()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2">Siguiente <i data-lucide="arrow-right" class="w-4 h-4"></i></button></div>
                </div>
                <div id="share-step-3" class="hidden flex flex-col h-full">
                     <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex-shrink-0">
                        <div class="flex items-center mb-4"><button onclick="goToShareStep2()" class="flex items-center text-sm font-bold text-slate-500 hover:text-indigo-600"><i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i> Atr√°s</button></div>
                        <div class="text-center"><div class="w-16 h-16 bg-indigo-50 dark:bg-indigo-900/30 rounded-2xl flex items-center justify-center mx-auto mb-4 text-indigo-600 dark:text-indigo-400"><i data-lucide="edit-3" class="w-8 h-8"></i></div><h2 class="text-xl font-bold text-slate-800 dark:text-white mb-2">Dale nombre a tu lista</h2><p class="text-sm text-slate-500">Ej: "Favoritos de Madrid", "Ruta de Tacos"</p></div>
                    </div>
                    <div class="p-8 flex-1 flex flex-col justify-center"><input type="text" id="share-list-name-input" placeholder="Escribe un nombre..." class="w-full p-4 text-lg text-center font-bold bg-slate-50 dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 rounded-2xl focus:border-indigo-500 focus:ring-0 outline-none text-slate-800 dark:text-white placeholder-slate-300"></div>
                    <div class="p-6 border-t border-slate-100 dark:border-slate-800 flex-shrink-0"><button onclick="finalizeShare()" id="btn-generate-link" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-emerald-200 dark:shadow-none">Generar Enlace <i data-lucide="link" class="w-4 h-4"></i></button></div>
                </div>
                <div id="share-step-result" class="hidden flex flex-col h-full items-center justify-center p-8 text-center">
                    <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-4"><i data-lucide="check" class="w-6 h-6"></i></div>
                    <h2 class="text-xl font-bold mb-2 text-slate-800 dark:text-white">¬°Enlace listo!</h2>
                    <div class="w-full bg-slate-100 dark:bg-slate-800 p-3 rounded-xl flex items-center gap-2 mb-6 border border-slate-200 dark:border-slate-700"><input id="share-final-link" readonly class="bg-transparent flex-1 text-xs font-mono outline-none text-slate-600 dark:text-slate-300 truncate"><button onclick="copyShareLink()" class="p-2 bg-white dark:bg-slate-700 rounded-lg shadow-sm hover:text-indigo-600"><i data-lucide="copy" class="w-4 h-4"></i></button></div>
                    <button onclick="closeShareWizard()" class="text-sm font-bold text-slate-500 hover:text-slate-800 dark:hover:text-white">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- HIDDEN INPUTS -->
        <input type="file" id="file-input-hidden" class="hidden" accept="image/*">
    </div>

    <!-- LOGIC SCRIPTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, deleteDoc, updateDoc, doc, getDoc, setDoc, orderBy, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = { apiKey: "AIzaSyCN6r1SI_546p7WdxxP28q3WAQWki7zkyI", authDomain: "restaurapp-5fe96.firebaseapp.com", projectId: "restaurapp-5fe96", storageBucket: "restaurapp-5fe96.firebasestorage.app", messagingSenderId: "612330319072", appId: "1:612330319072:web:a85e321306dd2b4ea73485", measurementId: "G-FC6RL56RNR" };
        const apiKey = ""; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let places = [];
        let currentSort = 'date-desc';
        let currentFilter = 'all';
        let currentSearch = '';
        let editingPlaceId = null;
        let isSharedViewMode = false;
        let unsubscribePlaces = null;
        let activePlaceId = null; 
        let mySharedLists = [];
        let currentProfile = null;
        
        let shareSelectedCats = [];
        let shareSelectedPlaces = [];
        
        let currentSuggestions = { good: [], bad: [] };
        let customCategories = [];
        
        let currentSharedListItems = [];
        let currentSharedSearch = '';
        let currentSharedSort = 'date-desc';
        let currentSharedFilter = 'all';
        let currentSharedUserFilter = 'all'; 
        let currentSharedListOwner = '';

        let formData = { name: '', type: 'Restaurante', address: '', date: new Date().toISOString().split('T')[0], rating: 0, comment: '', goodTags: [], badTags: [], images: ['', '', ''] };
        const defaultCategories = [
            {id: 'all', label: 'Todos', icon: 'filter'},
            {id: 'Restaurante', label: 'Restaurantes', icon: 'utensils'},
            {id: 'FoodTruck', label: 'Food Trucks', icon: 'truck'},
            {id: 'Bar', label: 'Bares', icon: 'music'},
            {id: 'Cafeteria', label: 'Caf√©', icon: 'coffee'},
            {id: 'Entretenimiento', label: 'Ocio', icon: 'tree-pine'}
        ];
        const AI_RECOMMENDATIONS_FALLBACK = { Restaurante: { good: ["Sabor aut√©ntico", "Servicio r√°pido"], bad: ["Ruidoso", "Lento"] }, FoodTruck: { good: ["Econ√≥mico", "Original"], bad: ["Sin asientos"] }, Bar: { good: ["M√∫sica", "Cocteles"], bad: ["Lleno"] }, Cafeteria: { good: ["Caf√©", "WiFi"], bad: ["Quemado"] }, Entretenimiento: { good: ["Divertido"], bad: ["Filas"] }, Otro: { good: ["Amable"], bad: ["Caro"] } };

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image(); img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const MAX_WIDTH = 600;
                        let width = img.width; let height = img.height;
                        if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } else { if (height > MAX_WIDTH) { width *= MAX_WIDTH / height; height = MAX_WIDTH; } }
                        canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                };
            });
        };

        window.switchView = (view) => {
            const homeTab = document.getElementById('tab-home'); const sharedTab = document.getElementById('tab-shared');
            const navHome = document.getElementById('nav-home'); const navShared = document.getElementById('nav-shared');
            const searchContainer = document.getElementById('header-search-container'); const catContainer = document.getElementById('header-categories-container');

            if (view === 'home') {
                homeTab.classList.remove('hidden'); sharedTab.classList.add('hidden');
                searchContainer.classList.remove('hidden'); catContainer.classList.remove('hidden');
                navHome.classList.add('bg-indigo-100', 'text-indigo-600', 'dark:bg-indigo-900', 'dark:text-indigo-300'); navHome.classList.remove('text-slate-400', 'hover:bg-slate-100', 'dark:hover:bg-slate-800');
                navShared.classList.remove('bg-indigo-100', 'text-indigo-600', 'dark:bg-indigo-900', 'dark:text-indigo-300'); navShared.classList.add('text-slate-400', 'hover:bg-slate-100', 'dark:hover:bg-slate-800');
            } else {
                homeTab.classList.add('hidden'); sharedTab.classList.remove('hidden');
                searchContainer.classList.add('hidden'); catContainer.classList.add('hidden');
                navShared.classList.add('bg-indigo-100', 'text-indigo-600', 'dark:bg-indigo-900', 'dark:text-indigo-300'); navShared.classList.remove('text-slate-400', 'hover:bg-slate-100', 'dark:hover:bg-slate-800');
                navHome.classList.remove('bg-indigo-100', 'text-indigo-600', 'dark:bg-indigo-900', 'dark:text-indigo-300'); navHome.classList.add('text-slate-400', 'hover:bg-slate-100', 'dark:hover:bg-slate-800');
            }
        };

        onAuthStateChanged(auth, async (user) => {
            const loading = document.getElementById('loading-screen');
            const loginView = document.getElementById('login-view');
            const mainView = document.getElementById('main-view');
            const params = new URLSearchParams(window.location.search);
            const sharedId = params.get('shared');

            if (sharedId) {
                if (!user) { try { await signInAnonymously(auth); return; } catch(e){} }
                isSharedViewMode = true; loadSharedList(sharedId);
                loginView.classList.add('hidden'); mainView.classList.remove('hidden');
                document.getElementById('btn-fab').classList.add('hidden'); document.getElementById('user-section').classList.add('hidden'); document.getElementById('bottom-nav').classList.add('hidden');
                loading.classList.add('hidden'); return;
            }

            if (user) {
                currentUser = user; await checkUserProfile();
            } else {
                currentUser = null; currentProfile = null;
                loginView.classList.remove('hidden'); mainView.classList.add('hidden'); document.getElementById('modal-username').classList.add('hidden');
                if (unsubscribePlaces) { unsubscribePlaces(); unsubscribePlaces = null; }
                loading.classList.add('hidden');
            }
        });
        
        async function checkUserProfile() {
            try {
                const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid);
                const snap = await getDoc(userRef);
                if (snap.exists() && snap.data().username) { currentProfile = snap.data(); showMainApp(); } 
                else { 
                    document.getElementById('loading-screen').classList.add('hidden'); 
                    document.getElementById('login-view').classList.add('hidden'); 
                    document.getElementById('modal-username').classList.remove('hidden'); 
                }
            } catch(e) { console.error("Profile error", e); showMainApp(); }
        }
        
        window.saveUsername = async (e) => {
            e.preventDefault(); const name = document.getElementById('input-username').value.trim(); if (!name) return;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid), { username: name, email: currentUser.email || 'guest', createdAt: serverTimestamp() }, { merge: true });
                currentProfile = { username: name }; document.getElementById('modal-username').classList.add('hidden'); showMainApp();
            } catch (err) { alert("Error al guardar perfil."); }
        }
        
        function showMainApp() {
            document.getElementById('loading-screen').classList.add('hidden'); document.getElementById('login-view').classList.add('hidden'); document.getElementById('main-view').classList.remove('hidden');
            setupRealtimeListener(); setupCategoriesListener(); setupSharedHistoryListener(); updateUserHeader();
        }

        document.getElementById('btn-google-login').addEventListener('click', async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch(e) { alert("Error login"); } });
        document.getElementById('btn-guest-login').addEventListener('click', () => signInAnonymously(auth));
        document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

        function updateUserHeader() {
            if (currentUser && currentProfile) {
                document.getElementById('user-name-display').innerText = currentProfile.username;
                document.getElementById('user-info-display').classList.remove('hidden');
                if (currentUser.photoURL) { document.getElementById('user-avatar').src = currentUser.photoURL; document.getElementById('user-avatar').classList.remove('hidden'); document.getElementById('user-icon-default').classList.add('hidden'); }
            }
        }

        function handleFirestoreError(err) { if (err.code === 'permission-denied') document.getElementById('permission-error-banner').classList.remove('hidden'); else console.error(err); }

        async function loadSharedList(shareId) {
            try {
                const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'shared_lists', shareId));
                if (snap.exists()) {
                    const data = snap.data(); places = data.items || [];
                    currentSharedListOwner = data.ownerName || 'Un usuario';
                    document.getElementById('app-title').innerHTML = `<i data-lucide="share-2" class="w-5 h-5"></i> ${data.categoryName || 'Compartido'}`;
                    renderPlaces();
                } else { alert("Lista no encontrada"); }
            } catch(e) { console.error(e); }
        }

        function setupRealtimeListener() {
            if (!currentUser) return; if (unsubscribePlaces) unsubscribePlaces();
            const q = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'places'));
            unsubscribePlaces = onSnapshot(q, (snapshot) => { places = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderPlaces(); }, handleFirestoreError);
        }
        
        function setupCategoriesListener() {
            if (!currentUser) return;
            onSnapshot(query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'custom_categories'), orderBy('name')), (snapshot) => {
                customCategories = snapshot.docs.map(doc => ({ id: doc.data().name, label: doc.data().name, icon: 'map-pin' }));
                renderCategories();
            }, (e) => console.log(e));
        }

        function setupSharedHistoryListener() {
            if (!currentUser) return;
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'shared_lists'), where('owner', '==', currentUser.uid)), (snapshot) => {
                mySharedLists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderSharedHistory();
            }, (e) => console.log(e));
        }

        function renderSharedHistory() {
            const container = document.getElementById('shared-history-list');
            if (mySharedLists.length === 0) { container.innerHTML = `<div class="text-center py-12 opacity-40"><p class="text-sm">A√∫n no has compartido ninguna lista.</p></div>`; return; }
            container.innerHTML = mySharedLists.map(list => `
                <div onclick="openSharedListModal('${list.id}')" class="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex justify-between items-center cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                    <div><h4 class="font-bold text-slate-800 dark:text-white">${list.categoryName}</h4><p class="text-xs text-slate-500 mt-1 flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ${list.items ? list.items.length : 0} sitios <span class="text-slate-300 mx-1">‚Ä¢</span> <span class="text-[10px]">A√±adido por: ${list.ownerName || 'M√≠'}</span></p></div><i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i>
                </div>`).join('');
            lucide.createIcons();
        }

        window.openSharedListModal = (listId) => {
            const list = mySharedLists.find(l => l.id === listId); if (!list) return;
            currentSharedListItems = list.items || [];
            currentSharedListOwner = list.ownerName || 'M√≠';
            document.getElementById('shared-view-title').innerText = list.categoryName;
            
            // Populate User Filter with just one option for now (the owner)
            const userSelect = document.getElementById('shared-select-user');
            userSelect.innerHTML = `<option value="all">Todos</option><option value="${currentSharedListOwner}">${currentSharedListOwner}</option>`;
            
            renderSharedCategories(); renderSharedPlaces();
            document.getElementById('modal-shared-list-view').classList.remove('hidden'); lucide.createIcons();
        }

        window.closeSharedListModal = () => document.getElementById('modal-shared-list-view').classList.add('hidden');

        // Shared View Filters Logic
        function renderSharedCategories() {
            const container = document.getElementById('shared-categories-container');
            const categoriesInList = [...new Set(currentSharedListItems.map(item => item.type))];
            const allKnownCats = [...defaultCategories, ...customCategories];
            const catsToRender = [{id: 'all', label: 'Todos', icon: 'filter'}];
            categoriesInList.forEach(catId => { const known = allKnownCats.find(c => c.id === catId); catsToRender.push({ id: catId, label: known ? known.label : catId, icon: known ? known.icon : 'map-pin' }); });
            container.innerHTML = catsToRender.map(cat => `<button onclick="setSharedCategory('${cat.id}')" class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap transition-colors ${currentSharedFilter === cat.id ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300 border border-indigo-200 dark:border-indigo-800' : 'text-white/70 hover:bg-white/10 hover:text-white'}"><i data-lucide="${cat.icon}" class="w-3 h-3"></i> ${cat.label}</button>`).join('');
            lucide.createIcons();
        }

        window.setSharedCategory = (id) => { currentSharedFilter = id; renderSharedCategories(); renderSharedPlaces(); };
        document.getElementById('shared-input-search').oninput = (e) => { currentSharedSearch = e.target.value; renderSharedPlaces(); };
        document.getElementById('shared-select-sort').onchange = (e) => { currentSharedSort = e.target.value; renderSharedPlaces(); };
        document.getElementById('shared-select-user').onchange = (e) => { currentSharedUserFilter = e.target.value; renderSharedPlaces(); };

        function renderSharedPlaces() {
            const grid = document.getElementById('shared-view-grid');
            let filtered = currentSharedListItems.filter(p => {
                const matchCat = currentSharedFilter === 'all' || p.type === currentSharedFilter;
                const searchLower = currentSharedSearch.toLowerCase();
                const matchSearch = !currentSharedSearch || p.name.toLowerCase().includes(searchLower);
                // User filter logic (trivial for now as only 1 user)
                const matchUser = currentSharedUserFilter === 'all' || currentSharedListOwner === currentSharedUserFilter;
                return matchCat && matchSearch && matchUser;
            });
            filtered.sort((a, b) => { if (currentSharedSort === 'date-desc') return new Date(b.date) - new Date(a.date); if (currentSharedSort === 'date-asc') return new Date(a.date) - new Date(b.date); return 0; });
            
            grid.innerHTML = filtered.map(p => {
                const img = (p.images && p.images[0]) ? p.images[0] : null;
                const goodTags = (p.goodTags || []).slice(0, 2);
                return `
                <div onclick="openDetailsFromObject(this)" data-place='${JSON.stringify(p).replace(/'/g, "&#39;")}' class="bg-white dark:bg-slate-900 rounded-3xl shadow-sm border border-slate-200/50 dark:border-slate-800 overflow-hidden group hover:shadow-xl transition-all duration-300 relative flex flex-col h-full cursor-pointer">
                    <div class="h-48 relative overflow-hidden flex-shrink-0">
                         ${img ? `<img src="${img}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105">` : `<div class="w-full h-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-300"><i data-lucide="image" class="w-10 h-10"></i></div>`}
                         <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-black/10 opacity-60"></div>
                         <div class="absolute top-3 left-3"><span class="px-2.5 py-1 bg-white/95 dark:bg-slate-900/90 backdrop-blur-md text-indigo-600 dark:text-indigo-400 text-[10px] font-bold uppercase tracking-wider rounded-lg shadow-sm border border-black/5 dark:border-white/10">${p.type}</span></div>
                         <div class="absolute top-3 right-3 flex items-center gap-1 bg-white/95 dark:bg-slate-900/90 backdrop-blur-md px-2 py-1 rounded-full shadow-sm border border-black/5 dark:border-white/10"><i data-lucide="star" class="w-3 h-3 text-amber-400 fill-amber-400"></i><span class="text-xs font-bold text-slate-700 dark:text-slate-200">${p.rating}</span></div>
                    </div>
                    <div class="p-5 flex-1 flex flex-col">
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white leading-tight line-clamp-1 mb-2">${p.name}</h3>
                        <div class="flex flex-col gap-0.5 text-xs text-slate-500 dark:text-slate-400 mb-3"><span class="flex items-center gap-1.5"><i data-lucide="map-pin" class="w-3 h-3 opacity-70"></i> ${p.address || 'Sin direcci√≥n'}</span></div>
                        <div class="mt-auto pt-2 border-t border-slate-100 dark:border-slate-800 flex justify-between items-center"><span class="text-[10px] text-slate-400 font-medium bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded">üë§ ${currentSharedListOwner}</span></div>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }
        
        window.openDetailsFromObject = (element) => {
            const p = JSON.parse(element.getAttribute('data-place'));
            document.getElementById('detail-name').innerText = p.name;
            document.getElementById('detail-type').innerText = p.type;
            document.getElementById('detail-rating').innerText = p.rating;
            document.getElementById('detail-date').innerText = new Date(p.date).toLocaleDateString();
            document.getElementById('detail-address').innerText = p.address || 'Sin direcci√≥n';
            document.getElementById('detail-added-by').innerText = currentSharedListOwner; // Show Owner
            document.getElementById('detail-added-by-container').classList.remove('hidden');
            
            // Images
            const imgCont = document.getElementById('detail-images');
            const validImgs = (p.images || []).filter(i => i);
            if (validImgs.length > 0) imgCont.innerHTML = validImgs.map(src => `<div class="w-full flex-shrink-0 h-full snap-center"><img src="${src}" class="w-full h-full object-cover"></div>`).join('');
            else imgCont.innerHTML = `<div class="w-full h-full flex items-center justify-center text-slate-400"><i data-lucide="image" class="w-16 h-16"></i></div>`;
            
            // Tags
            let tagsHtml = '';
            if (p.goodTags?.length) tagsHtml += `<div><h4 class="text-xs font-bold text-emerald-600 mb-2">LO MEJOR</h4><div class="flex flex-wrap gap-2">${p.goodTags.map(t=>`<span class="px-3 py-1 bg-emerald-50 text-emerald-700 rounded-lg text-xs font-bold">${t}</span>`).join('')}</div></div>`;
            document.getElementById('detail-tags-section').innerHTML = tagsHtml || '<p class="text-xs text-slate-400">Sin etiquetas</p>';
            
            if (p.comment) { document.getElementById('detail-comment').innerText = p.comment; document.getElementById('detail-comment-section').classList.remove('hidden'); }
            else document.getElementById('detail-comment-section').classList.add('hidden');
            
            document.getElementById('detail-actions').classList.add('hidden');
            document.getElementById('modal-details').classList.remove('hidden');
            lucide.createIcons();
        }

        // ... (Share Wizard Logic remains same, just adding ownerName to setDoc in finalizeShare) ...
        window.openShareWizard = () => { document.getElementById('modal-share-wizard').classList.remove('hidden'); shareSelectedCats = []; shareSelectedPlaces = []; goToShareStep1(); }
        window.closeShareWizard = () => document.getElementById('modal-share-wizard').classList.add('hidden');
        window.goToShareStep1 = () => {
             document.getElementById('share-step-1').classList.remove('hidden'); document.getElementById('share-step-2').classList.add('hidden'); document.getElementById('share-step-3').classList.add('hidden'); document.getElementById('share-step-result').classList.add('hidden');
             const list = document.getElementById('share-cat-list');
             const allCats = [...defaultCategories.filter(c => c.id !== 'all'), ...customCategories];
             list.innerHTML = allCats.map(c => `<label class="checkbox-wrapper flex items-center p-3 rounded-xl border border-slate-200 dark:border-slate-700 cursor-pointer hover:bg-white dark:hover:bg-slate-700 transition-colors bg-white dark:bg-slate-900"><input type="checkbox" class="hidden" value="${c.id}" onchange="toggleShareCat('${c.id}')" ${shareSelectedCats.includes(c.id)?'checked':''}><div class="w-5 h-5 rounded border border-slate-300 dark:border-slate-500 mr-3 flex items-center justify-center text-white"><i data-lucide="check" class="w-3 h-3 hidden"></i></div><div class="flex items-center gap-2 font-medium text-slate-800 dark:text-white"><i data-lucide="${c.icon}" class="w-4 h-4 text-slate-400"></i> ${c.label}</div></label>`).join('');
             lucide.createIcons();
        }
        window.toggleShareCat = (id) => { const idx = shareSelectedCats.indexOf(id); if (idx > -1) shareSelectedCats.splice(idx, 1); else shareSelectedCats.push(id); }
        window.toggleSelectAllCats = () => { const allCats = [...defaultCategories.filter(c => c.id !== 'all'), ...customCategories]; if (shareSelectedCats.length === allCats.length) shareSelectedCats = []; else shareSelectedCats = allCats.map(c => c.id); goToShareStep1(); }
        window.goToShareStep2 = () => {
            if (shareSelectedCats.length === 0) return alert("Selecciona una categor√≠a");
            document.getElementById('share-step-1').classList.add('hidden'); document.getElementById('share-step-3').classList.add('hidden'); document.getElementById('share-step-2').classList.remove('hidden');
            const filtered = places.filter(p => shareSelectedCats.includes(p.type));
            const list = document.getElementById('share-place-list');
            if (filtered.length === 0) { list.innerHTML = `<div class="text-center p-8 text-slate-400">No hay sitios.</div>`; return; }
            list.innerHTML = filtered.map(p => `<label class="checkbox-wrapper flex items-center p-3 rounded-xl border border-slate-200 dark:border-slate-700 cursor-pointer hover:bg-white dark:hover:bg-slate-700 transition-colors bg-white dark:bg-slate-900 mb-2"><input type="checkbox" class="hidden" value="${p.id}" onchange="toggleSharePlace('${p.id}')" ${shareSelectedPlaces.includes(p.id)?'checked':''}><div class="w-5 h-5 rounded border border-slate-300 dark:border-slate-500 mr-3 flex items-center justify-center text-white flex-shrink-0"><i data-lucide="check" class="w-3 h-3 ${shareSelectedPlaces.includes(p.id)?'':'hidden'}"></i></div><div class="flex-1 min-w-0"><div class="font-bold truncate text-sm text-slate-800 dark:text-white">${p.name}</div><div class="text-xs text-slate-400 truncate">${p.address || 'Sin direcci√≥n'}</div></div></label>`).join('');
            lucide.createIcons();
        }
        window.toggleSharePlace = (id) => { const idx = shareSelectedPlaces.indexOf(id); if (idx > -1) shareSelectedPlaces.splice(idx, 1); else shareSelectedPlaces.push(id); }
        window.toggleSelectAllShare = () => { const filtered = places.filter(p => shareSelectedCats.includes(p.type)); if (shareSelectedPlaces.length === filtered.length) shareSelectedPlaces = []; else shareSelectedPlaces = filtered.map(p => p.id); goToShareStep2(); }
        window.goToShareStep3 = () => { if (shareSelectedPlaces.length === 0) return alert("Selecciona un sitio"); document.getElementById('share-step-2').classList.add('hidden'); document.getElementById('share-step-3').classList.remove('hidden'); setTimeout(()=>document.getElementById('share-list-name-input').focus(),100); }
        window.finalizeShare = async () => {
            const btn = document.getElementById('btn-generate-link'); btn.innerHTML = "...";
            const name = document.getElementById('share-list-name-input').value.trim() || "Favoritos";
            try {
                const items = places.filter(p => shareSelectedPlaces.includes(p.id));
                const shareId = crypto.randomUUID();
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'shared_lists', shareId), {
                    items: items, categoryName: name, createdAt: serverTimestamp(), owner: currentUser.uid, ownerName: currentProfile?.username || 'An√≥nimo'
                });
                document.getElementById('share-final-link').value = `${window.location.href.split('?')[0]}?shared=${shareId}`;
                document.getElementById('share-step-3').classList.add('hidden'); document.getElementById('share-step-result').classList.remove('hidden');
            } catch(e) { alert("Error"); }
            btn.innerHTML = "Generar";
        }
        window.copyShareLink = () => { const i = document.getElementById('share-final-link'); i.select(); document.execCommand('copy'); alert("Copiado"); }

        // --- MAIN RENDER ---
        function renderPlaces() {
            const grid = document.getElementById('places-grid');
            const empty = document.getElementById('empty-state');
            
            let filtered = places.filter(p => {
                const matchCat = currentFilter === 'all' || p.type === currentFilter;
                const searchLower = currentSearch.toLowerCase();
                const matchSearch = !currentSearch || 
                    p.name.toLowerCase().includes(searchLower) || 
                    (p.address && p.address.toLowerCase().includes(searchLower));
                return matchCat && matchSearch;
            });

            if (filtered.length === 0) {
                grid.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            grid.innerHTML = filtered.map(p => {
                const img = (p.images && p.images[0]) ? p.images[0] : null;
                const goodTags = (p.goodTags || []).slice(0, 3);
                const badTags = (p.badTags || []).slice(0, 3);
                
                // Truncate comment to 50 chars with ...
                const commentPreview = p.comment && p.comment.length > 50 
                    ? p.comment.substring(0, 50) + '...' 
                    : (p.comment || '');

                return `
                <div onclick="openDetails('${p.id}')" class="bg-white dark:bg-slate-900 rounded-3xl shadow-sm border border-slate-200/50 dark:border-slate-800 overflow-hidden group hover:shadow-xl transition-all duration-300 relative flex flex-col h-full cursor-pointer">
                    <!-- Image Header -->
                    <div class="h-48 relative overflow-hidden flex-shrink-0">
                         ${img ? `<img src="${img}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105">` : 
                         `<div class="w-full h-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-300"><i data-lucide="image" class="w-10 h-10"></i></div>`}
                         
                         <!-- Overlay Gradient -->
                         <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-black/10 opacity-60"></div>
                         
                         <!-- Badges -->
                         <div class="absolute top-3 left-3">
                            <span class="px-2.5 py-1 bg-white/95 dark:bg-slate-900/90 backdrop-blur-md text-indigo-600 dark:text-indigo-400 text-[10px] font-bold uppercase tracking-wider rounded-lg shadow-sm border border-black/5 dark:border-white/10">
                                ${p.type}
                            </span>
                         </div>
                         <div class="absolute top-3 right-3 flex items-center gap-1 bg-white/95 dark:bg-slate-900/90 backdrop-blur-md px-2 py-1 rounded-full shadow-sm border border-black/5 dark:border-white/10">
                            <i data-lucide="star" class="w-3 h-3 text-amber-400 fill-amber-400"></i>
                            <span class="text-xs font-bold text-slate-700 dark:text-slate-200">${p.rating}</span>
                         </div>

                         <!-- Delete Button (Top Right) -->
                         ${!isSharedViewMode ? `
                         <button onclick="event.stopPropagation(); deletePlace('${p.id}')" class="absolute top-3 right-16 p-1.5 bg-white/95 dark:bg-slate-900/90 text-red-500 rounded-full shadow-sm border border-black/5 dark:border-white/10 hover:bg-red-50 dark:hover:bg-red-900/30 transition-colors z-20">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                         </button>` : ''}
                    </div>

                    <!-- Body -->
                    <div class="p-5 flex-1 flex flex-col">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-slate-900 dark:text-white leading-tight line-clamp-1">${p.name}</h3>
                        </div>
                        
                        <!-- Fixed Compact Metadata -->
                        <div class="flex flex-col gap-0.5 text-xs text-slate-500 dark:text-slate-400 mb-3">
                            <span class="flex items-center gap-1.5">
                                <i data-lucide="calendar" class="w-3 h-3 opacity-70"></i> 
                                ${new Date(p.date).toLocaleDateString(undefined, {month:'short', day:'numeric', year: 'numeric'})}
                            </span>
                            <span class="flex items-center gap-1.5 truncate">
                                <i data-lucide="map-pin" class="w-3 h-3 opacity-70"></i> 
                                ${p.address || 'Sin direcci√≥n'}
                            </span>
                        </div>

                        <!-- Tags Section -->
                        <div class="mb-4 space-y-2">
                            ${goodTags.length > 0 ? `
                            <div class="flex flex-wrap gap-1.5">
                                ${goodTags.map(t => `<span class="px-2 py-0.5 rounded-md text-[10px] font-bold bg-emerald-50 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400 border border-emerald-100 dark:border-emerald-800/50 flex items-center gap-1"><i data-lucide="thumbs-up" class="w-2 h-2"></i> ${t}</span>`).join('')}
                            </div>` : ''}
                            
                            ${badTags.length > 0 ? `
                            <div class="flex flex-wrap gap-1.5">
                                ${badTags.map(t => `<span class="px-2 py-0.5 rounded-md text-[10px] font-bold bg-red-50 text-red-600 dark:bg-red-900/30 dark:text-red-400 border border-red-100 dark:border-red-800/50 flex items-center gap-1"><i data-lucide="thumbs-down" class="w-2 h-2"></i> ${t}</span>`).join('')}
                            </div>` : ''}
                        </div>

                        ${commentPreview ? `
                        <div class="mt-auto relative bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-800/50">
                            <i data-lucide="quote" class="w-3 h-3 text-indigo-300 absolute top-2 left-2 transform -scale-x-100"></i>
                            <p class="text-xs text-slate-600 dark:text-slate-400 italic line-clamp-2 pl-4">"${commentPreview}"</p>
                        </div>` : ''}
                    </div>
                </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        // --- DETAILS MODAL LOGIC ---
        window.openDetails = (id) => {
            const p = places.find(x => x.id === id);
            if (!p) return;
            activePlaceId = id;

            document.getElementById('detail-name').innerText = p.name;
            document.getElementById('detail-type').innerText = p.type;
            document.getElementById('detail-rating').innerText = p.rating;
            document.getElementById('detail-date').innerText = new Date(p.date).toLocaleDateString(undefined, {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
            document.getElementById('detail-address').innerText = p.address || 'Sin direcci√≥n registrada';
            document.getElementById('detail-added-by-container').classList.add('hidden'); // Hide added by for personal list
            
            // Images
            const imagesContainer = document.getElementById('detail-images');
            const imageCountBadge = document.getElementById('detail-image-count');
            let imgsHtml = '';
            let validImages = (p.images || []).filter(img => img);
            
            if (validImages.length > 0) {
                imgsHtml = validImages.map(img => `
                    <div class="w-full flex-shrink-0 h-full snap-center relative">
                        <img src="${img}" class="w-full h-full object-cover">
                    </div>
                `).join('');
                
                // Show counter if more than 1 image
                if (validImages.length > 1) {
                    document.getElementById('detail-image-count-text').innerText = `${validImages.length} Fotos`;
                    imageCountBadge.classList.remove('hidden');
                } else {
                    imageCountBadge.classList.add('hidden');
                }

            } else {
                 imgsHtml = `<div class="w-full h-full flex items-center justify-center text-slate-400"><i data-lucide="image" class="w-16 h-16"></i></div>`;
                 imageCountBadge.classList.add('hidden');
            }
            imagesContainer.innerHTML = imgsHtml;

            // Tags
            const tagsContainer = document.getElementById('detail-tags-section');
            let tagsHtml = '';
            if (p.goodTags && p.goodTags.length > 0) {
                tagsHtml += `
                <div>
                    <h4 class="text-xs font-bold text-emerald-600 uppercase mb-2 flex items-center gap-1"><i data-lucide="thumbs-up" class="w-3 h-3"></i> Lo Mejor</h4>
                    <div class="flex flex-wrap gap-2">
                        ${p.goodTags.map(t => `<span class="px-3 py-1 bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400 rounded-lg text-xs font-bold border border-emerald-100 dark:border-emerald-800/50">${t}</span>`).join('')}
                    </div>
                </div>`;
            }
            if (p.badTags && p.badTags.length > 0) {
                tagsHtml += `
                <div class="mt-3">
                    <h4 class="text-xs font-bold text-red-600 uppercase mb-2 flex items-center gap-1"><i data-lucide="thumbs-down" class="w-3 h-3"></i> A Mejorar</h4>
                    <div class="flex flex-wrap gap-2">
                        ${p.badTags.map(t => `<span class="px-3 py-1 bg-red-50 text-red-700 dark:bg-red-900/30 dark:text-red-400 rounded-lg text-xs font-bold border border-red-100 dark:border-red-800/50">${t}</span>`).join('')}
                    </div>
                </div>`;
            }
            tagsContainer.innerHTML = tagsHtml || '<p class="text-xs text-slate-400 italic">Sin etiquetas registradas.</p>';

            // Comment
            const commentSec = document.getElementById('detail-comment-section');
            if (p.comment) {
                document.getElementById('detail-comment').innerText = `"${p.comment}"`;
                commentSec.classList.remove('hidden');
            } else {
                commentSec.classList.add('hidden');
            }

            // Edit Button Visibility
            const actionsDiv = document.getElementById('detail-actions');
            if (isSharedViewMode) {
                actionsDiv.classList.add('hidden');
            } else {
                actionsDiv.classList.remove('hidden');
            }

            document.getElementById('modal-details').classList.remove('hidden');
            lucide.createIcons();
        };

        window.closeDetails = () => {
            document.getElementById('modal-details').classList.add('hidden');
        };

        window.editFromDetails = () => {
            closeDetails();
            openEdit(activePlaceId);
        };

        // --- FORM LOGIC ---
        const modal = document.getElementById('modal-form');
        const form = document.getElementById('place-form');
        const typeSelect = document.getElementById('input-type');
        
        function renderTypeOptions(selectedValue) {
            const allCats = [...defaultCategories.filter(c => c.id !== 'all'), ...customCategories];
            const html = allCats.map(c => `<option value="${c.id}" ${c.id === selectedValue ? 'selected' : ''}>${c.label}</option>`).join('') +
                         `<option value="__custom__">‚ûï Otro...</option>`;
            typeSelect.innerHTML = html;
            if (selectedValue) typeSelect.value = selectedValue;
        }

        function renderStars(rating) {
            const container = document.getElementById('star-rating-container');
            container.innerHTML = [1,2,3,4,5].map(i => `
                <button type="button" onclick="setRating(${i})" class="focus:outline-none transition-transform hover:scale-110">
                    <i data-lucide="star" class="w-8 h-8 ${i <= rating ? 'text-amber-400 fill-amber-400' : 'text-slate-300 dark:text-slate-700'}"></i>
                </button>
            `).join('');
            document.getElementById('rating-value').innerText = `${rating}/5`;
            lucide.createIcons();
        }
        window.setRating = (r) => { formData.rating = r; renderStars(r); };

        function updateSuggestions(type) {
            const fallback = AI_RECOMMENDATIONS_FALLBACK[type] || AI_RECOMMENDATIONS_FALLBACK['Otro'];
            currentSuggestions = {
                good: [...fallback.good],
                bad: [...fallback.bad]
            };
            renderFormTags();
        }

        // Handle input type change - Show input if custom
        document.getElementById('input-type').addEventListener('change', async (e) => {
            const val = e.target.value;
            const customInput = document.getElementById('input-custom-type');
            
            if (val === '__custom__') {
                customInput.classList.remove('hidden');
                customInput.focus();
                formData.type = ''; // Clear type until entered
            } else {
                customInput.classList.add('hidden');
                formData.type = val;
                updateSuggestions(val);
            }
        });

        function fillForm() {
            if (document.getElementById('input-name')) document.getElementById('input-name').value = formData.name;
            
            // Check if type is custom or exists in list
            const allCats = [...defaultCategories, ...customCategories];
            const typeExists = allCats.some(c => c.id === formData.type);
            const customInput = document.getElementById('input-custom-type');
            
            renderTypeOptions(formData.type); // Render list

            if (typeExists || formData.type === 'Restaurante') {
                document.getElementById('input-type').value = formData.type;
                customInput.classList.add('hidden');
                customInput.value = '';
            } else {
                // It's a new custom type not yet saved or loaded?
                document.getElementById('input-type').value = '__custom__';
                customInput.classList.remove('hidden');
                customInput.value = formData.type;
            }
            
            if (document.getElementById('input-address')) document.getElementById('input-address').value = formData.address || '';
            if (document.getElementById('input-comment')) document.getElementById('input-comment').value = formData.comment || '';
            setRating(formData.rating || 0);
            
            if (!editingPlaceId) updateSuggestions(formData.type);

            renderFormTags();
            updateImagePreview(0);
            updateImagePreview(1);
            updateImagePreview(2);
            
            if (formData.images && formData.images[0]) {
                document.getElementById('btn-analyze-ai').classList.remove('hidden');
            } else {
                document.getElementById('btn-analyze-ai').classList.add('hidden');
            }
        }

        function renderFormTags() {
            const goodC = document.getElementById('tags-good-container');
            const badC = document.getElementById('tags-bad-container');
            
            const allGood = [...new Set([...currentSuggestions.good, ...formData.goodTags])];
            const allBad = [...new Set([...currentSuggestions.bad, ...formData.badTags])];

            const renderTag = (t, type) => `
                <button type="button" onclick="toggleFormTag('${t}', '${type}')" 
                    class="text-xs px-3 py-1 rounded-full border transition-all ${
                        (type === 'good' ? formData.goodTags : formData.badTags).includes(t) 
                        ? (type === 'good' ? 'bg-green-600 text-white border-green-600' : 'bg-red-600 text-white border-red-600') 
                        : 'bg-white dark:bg-slate-800 text-slate-500 border-slate-200 dark:border-slate-700'
                    }">
                    ${t}
                </button>
            `;
            
            goodC.innerHTML = allGood.map(t => renderTag(t, 'good')).join('');
            badC.innerHTML = allBad.map(t => renderTag(t, 'bad')).join('');
        }

        window.toggleFormTag = (t, type) => {
            const arr = type === 'good' ? formData.goodTags : formData.badTags;
            const idx = arr.indexOf(t);
            if (idx > -1) arr.splice(idx, 1); else arr.push(t);
            renderFormTags();
        }

        function updateImagePreview(idx) {
            const img = document.getElementById(`preview-img-${idx}`);
            const ph = document.getElementById(`upload-placeholder-${idx}`);
            const btn = document.getElementById(`btn-remove-img-${idx}`);
            
            if (formData.images && formData.images[idx]) {
                img.src = formData.images[idx];
                img.classList.remove('hidden');
                ph.classList.add('hidden');
                btn.classList.remove('hidden');
            } else {
                img.classList.add('hidden');
                ph.classList.remove('hidden');
                btn.classList.add('hidden');
            }
        }

        window.handleImageUpload = async (input, idx) => {
            const file = input.files[0];
            if (file) {
                try {
                    const compressed = await compressImage(file);
                    formData.images[idx] = compressed;
                    updateImagePreview(idx);
                    if (idx === 0) document.getElementById('btn-analyze-ai').classList.remove('hidden');
                } catch (err) {
                    console.error("Error compressing image", err);
                    alert("Error al procesar la imagen.");
                }
            }
        };

        document.getElementById('btn-remove-img-0').onclick = () => {
            formData.images[0] = '';
            updateImagePreview(0);
            document.getElementById('btn-analyze-ai').classList.add('hidden');
        };

        document.getElementById('btn-remove-img-1').onclick = () => {
            formData.images[1] = '';
            updateImagePreview(1);
        };
        document.getElementById('btn-remove-img-2').onclick = () => {
            formData.images[2] = '';
            updateImagePreview(2);
        };

        document.getElementById('btn-fab').onclick = () => {
            editingPlaceId = null;
            formData = { name: '', type: 'Restaurante', address: '', date: new Date().toISOString().split('T')[0], rating: 0, comment: '', goodTags: [], badTags: [], images: ['', '', ''] };
            document.getElementById('modal-title').innerText = 'Nuevo Sitio';
            document.getElementById('edit-id').value = '';
            renderTypeOptions(); // Ensure custom types are loaded
            fillForm();
            modal.classList.remove('hidden');
        };
        
        window.openEdit = (id) => {
            if (isSharedViewMode) return;
            const p = places.find(x => x.id === id);
            if (!p) return;
            editingPlaceId = id;
            formData = { ...p, images: p.images || ['', '', ''] };
            document.getElementById('modal-title').innerText = 'Editar Sitio';
            document.getElementById('edit-id').value = id;
            renderTypeOptions(); // Ensure custom types are loaded
            fillForm();
            modal.classList.remove('hidden');
        }
        document.getElementById('btn-close-modal').onclick = () => modal.classList.add('hidden');

        form.onsubmit = async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                const tryLogin = confirm("Necesitas iniciar sesi√≥n para guardar. ¬øDeseas entrar como invitado?");
                if (tryLogin) {
                    try {
                        await signInAnonymously(auth);
                        return;
                    } catch (err) {
                        alert("Error de autenticaci√≥n: " + err.message);
                        return;
                    }
                } else {
                    return;
                }
            }
            
            formData.name = document.getElementById('input-name').value;
            // Handle Custom Type Logic
            let finalType = formData.type;
            const typeSelectVal = document.getElementById('input-type').value;
            
            if (typeSelectVal === '__custom__') {
                const customName = document.getElementById('input-custom-type').value.trim();
                if (!customName) return alert("Por favor escribe un nombre para la categor√≠a.");
                finalType = customName;
                
                // Save custom category if new
                const exists = defaultCategories.some(c => c.id === finalType) || customCategories.some(c => c.id === finalType);
                if (!exists) {
                     try {
                         await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'custom_categories'), {
                             name: finalType,
                             createdAt: serverTimestamp()
                         });
                     } catch(err) { console.error("Error saving category", err); }
                }
            } else {
                finalType = typeSelectVal;
            }
            formData.type = finalType;
            
            formData.address = document.getElementById('input-address').value;
            formData.comment = document.getElementById('input-comment').value;

            // Calculate size
            const payloadSize = new Blob([JSON.stringify(formData)]).size;
            if (payloadSize > 950000) { // ~950KB limit
                alert("Las im√°genes son demasiado grandes. Por favor, elimina alguna o usa fotos m√°s peque√±as.");
                return;
            }
            
            const btnSubmit = form.querySelector('button[type="submit"]');
            btnSubmit.disabled = true;
            btnSubmit.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-5 h-5 inline"></i> Guardando...`;
            lucide.createIcons();

            try {
                const collectionRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'places');
                
                if (editingPlaceId) {
                    await updateDoc(doc(collectionRef, editingPlaceId), formData);
                } else {
                    await addDoc(collectionRef, {
                        ...formData,
                        createdAt: serverTimestamp()
                    });
                }
                modal.classList.add('hidden');
            } catch (err) { 
                console.error("Save Error:", err);
                if (err.code === 'resource-exhausted') {
                    alert("Error: Has superado el l√≠mite de cuota diario de Firebase o la imagen es demasiado grande. Intenta ma√±ana o usa im√°genes m√°s peque√±as.");
                } else {
                    alert("Error guardando: " + err.message); 
                }
            } finally {
                btnSubmit.disabled = false;
                btnSubmit.innerText = "Guardar Sitio";
            }
        };

        window.deletePlace = async (id) => {
            if (confirm("¬øBorrar este sitio?")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'places', id));
                } catch (err) { console.error(err); }
            }
        };

        // UI Helpers & Init
        function renderCategories() { /* ... kept simple ... */ 
            const container = document.getElementById('categories-container');
            const allCats = [...defaultCategories, ...customCategories]; // Include custom cats in main filter
            
            container.innerHTML = allCats.map(cat => `
                <button onclick="setCategory('${cat.id}')" class="flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${currentFilter === cat.id ? 'bg-indigo-100 text-indigo-700 border-indigo-200 dark:bg-indigo-900/50 dark:text-indigo-300 dark:border-indigo-800 border' : 'text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800'}">
                    <i data-lucide="${cat.icon}" class="w-4 h-4"></i> ${cat.label}
                </button>`).join('');
            lucide.createIcons();
        }
        window.setCategory = (id) => { currentFilter = id; renderCategories(); renderPlaces(); };
        window.copyDomain = () => { navigator.clipboard.writeText(document.getElementById('domain-code').innerText); alert("Copiado!"); };
        document.getElementById('btn-theme-toggle').onclick = () => {
            document.documentElement.classList.toggle('dark');
            lucide.createIcons();
        };

        // Init
        renderCategories();
        renderTypeOptions(); // Initial render
        lucide.createIcons();
    </script>
</body>
</html>
